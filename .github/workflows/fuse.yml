name: Fuse Typefaces

on:
  schedule:
    - cron: "0 * * * *" # æ¯å°æ—¶è¿è¡Œä¸€æ¬¡
  workflow_dispatch:

jobs:
  check_updates:
    runs-on: ubuntu-latest
    outputs:
      is_commit_updated: ${{ steps.check_commit.outputs.is_updated }}
      is_release_updated: ${{ steps.check_release.outputs.is_updated }}

    steps:
      - name: ğŸ”„ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ” Check Latest Commit Updates
        id: check_commit
        run: |
          JETBRAINS_COMMIT=$(git ls-remote https://github.com/JetBrains/JetBrainsMono.git refs/heads/master | awk '{print $1}')
          MAPLE_COMMIT=$(git ls-remote https://github.com/subframe7536/maple-font.git refs/heads/main | awk '{print $1}')

          echo "Latest JetBrains Mono Commit: $JETBRAINS_COMMIT"
          echo "Latest Maple Font Commit: $MAPLE_COMMIT"

          PREV_JETBRAINS_COMMIT=$(cat jetbrains_commit.txt 2>/dev/null || echo "")
          PREV_MAPLE_COMMIT=$(cat maple_commit.txt 2>/dev/null || echo "")

          if [[ "$JETBRAINS_COMMIT" != "$PREV_JETBRAINS_COMMIT" || "$MAPLE_COMMIT" != "$PREV_MAPLE_COMMIT" ]]; then
            echo "is_updated=true" >> $GITHUB_OUTPUT
            echo "$JETBRAINS_COMMIT" > jetbrains_commit.txt
            echo "$MAPLE_COMMIT" > maple_commit.txt
          else
            echo "is_updated=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ” Check Latest Release Updates
        id: check_release
        run: |
          JETBRAINS_RELEASE=$(curl -s https://api.github.com/repos/JetBrains/JetBrainsMono/releases/latest | jq -r '.tag_name')
          MAPLE_RELEASE=$(curl -s https://api.github.com/repos/subframe7536/maple-font/releases/latest | jq -r '.tag_name')

          echo "Latest JetBrains Mono Release: $JETBRAINS_RELEASE"
          echo "Latest Maple Font Release: $MAPLE_RELEASE"

          PREV_JETBRAINS_RELEASE=$(cat jetbrains_release.txt 2>/dev/null || echo "")
          PREV_MAPLE_RELEASE=$(cat maple_release.txt 2>/dev/null || echo "")

          if [[ "$JETBRAINS_RELEASE" != "$PREV_JETBRAINS_RELEASE" || "$MAPLE_RELEASE" != "$PREV_MAPLE_RELEASE" ]]; then
            echo "is_updated=true" >> $GITHUB_OUTPUT
            echo "$JETBRAINS_RELEASE" > jetbrains_release.txt
            echo "$MAPLE_RELEASE" > maple_release.txt
          else
            echo "is_updated=false" >> $GITHUB_OUTPUT
          fi

  fuse_and_commit:
    needs: check_updates
    if: needs.check_updates.outputs.is_commit_updated == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ”„ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 'latest'

      - name: ğŸ“¦ Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python python-venv python-dev fontforge
          python -m venv venv
          source venv/bin/activate || . venv/bin/activate
          pip install gftools fonttools

      - name: ğŸ”½ Clone and Build JetBrains Mono from Source
        run: |
          git clone --depth 1 https://github.com/JetBrains/JetBrainsMono.git
          cd JetBrainsMono
          gftools builder sources/config.yaml
          cd ..
          mkdir -p fonts/jetbrains
          cp -r JetBrainsMono/fonts/ttf/* fonts/jetbrains/

      - name: ğŸ”½ Clone and Build Maple Font from Source
        run: |
          git clone --depth 1 https://github.com/subframe7536/maple-font.git
          cd maple-font
          python -m venv venv
          source venv/bin/activate || . venv/bin/activate
          pip install -r requirements.txt
          python build.py --cn --no-liga
          cd ..
          mkdir -p fonts/maple
          cp -r maple-font/build/MapleMono/MapleMono\ CN/ttf/* fonts/maple/

      - name: ğŸ¯ Fuse JetBrains Mono & Maple Font
        run: |
          mkdir -p fused_fonts
          for style in Regular Bold Italic BoldItalic ExtraLight ExtraLightItalic Light LightItalic Medium MediumItalic SemiBold SemiBoldItalic Thin ThinItalic ExtraBold ExtraBoldItalic; do
            JETBRAINS_FONT="fonts/jetbrains/JetBrainsMono-${style}.ttf"
            MAPLE_FONT="fonts/maple/MapleMonoCN-${style}.ttf"
            if [[ -f "$JETBRAINS_FONT" && -f "$MAPLE_FONT" ]]; then
              echo "Fusing $JETBRAINS_FONT and $MAPLE_FONT..."
              pyftfuse "$MAPLE_FONT" "$JETBRAINS_FONT"
              mv fused.ttf "fused_fonts/JetBrainsMapleMono-${style}.ttf"
            fi
          done

      - name: âœï¸ Commit and Push Fused Fonts
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add fused_fonts/*.ttf jetbrains_commit.txt maple_commit.txt
          git commit -m "Auto-fuse latest JetBrains Mono and Maple Font (new commit detected)"
          git push

  fuse_and_release:
    needs: check_updates
    if: needs.check_updates.outputs.is_release_updated == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ”„ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Install Dependencies
        run: pip install fonttools

      - name: ğŸ› ï¸ Ensure fuse_fonts.sh is executable
        run: chmod +x ./fuse_fonts.sh

      - name: ğŸ”½ Download and Fuse Fonts
        run: |
          ./fuse_fonts.sh  # è°ƒç”¨åˆå¹¶å­—ä½“çš„è„šæœ¬

      - name: ğŸ“¦ Create ZIP Archive
        run: |
          zip -r JetBrainsMapleMono.zip fused_fonts/

      - name: ğŸš€ Publish to GitHub Releases
        uses: softprops/action-gh-release@v1
        with:
          files: JetBrainsMapleMono.zip
          tag_name: latest
          name: "Latest Fused Font"
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.FUSION_JET_BRAINS_MAPLE_MONO_TOKEN }}
